name: services

secrets:
  DRAGONFLY_MAIN_PASSWORD:
    environment: DRAGONFLY_MAIN_PASSWORD

services:
  # Dragonfly
  dragonfly-main:
    container_name: dragonfly-main
    entrypoint: /opt/dragonfly/entrypoint.sh
    image: docker.dragonflydb.io/dragonflydb/dragonfly
    ports:
      - ${DRAGONFLY_MAIN_EXPOSE_HOST}:${DRAGONFLY_MAIN_EXPOSE_PORT:-6379}:6379
    restart: always
    secrets:
      - DRAGONFLY_MAIN_PASSWORD
    ulimits:
      memlock: -1
    volumes:
      - ./dragonfly:/opt/dragonfly
      - dragonfly-main-data:/data

  # MariaDB
  mariadb-main:
    container_name: mariadb-main
    environment:
      MARIADB_ROOT_PASSWORD: '${MARIADB_MAIN_ROOT_PASSWORD}'
      TZ: '${MARIADB_MAIN_TZ}'
    image: mariadb:latest
    ports:
      - '${MARIADB_MAIN_EXPOSE_HOST}:${MARIADB_MAIN_EXPOSE_PORT:-3306}:3306'
    restart: always
    volumes:
      - '${MARIADB_MAIN_BACKUPS_PATH}:/mnt/backups'
      - '${MARIADB_MAIN_FILES_PATH}:/var/lib/mysql'
      - ./mariadb/conf.d:/etc/mysql/conf.d

  # MongoDB
  mongodb-main:
    container_name: mongodb-main
    entrypoint: /opt/mongodb/entrypoint.sh
    hostname: mongodb-main
    image: mongodb/mongodb-community-server:8.2-ubuntu2204
    ports:
      - '${MONGODB_MAIN_EXPOSE_HOST}:${MONGODB_MAIN_EXPOSE_PORT}:27017'
    restart: always
    user: root:nogroup
    volumes:
      - '${MONGODB_MAIN_BACKUPS_PATH}:/mnt/backups'
      - '${MONGODB_MAIN_FILES_PATH}:/data/db'
      - ./mongodb:/opt/mongodb
      - mongodb-main-config:/data/configdb

  # phpMyAdmin
  phpmyadmin:
    container_name: phpmyadmin
    image: phpmyadmin/phpmyadmin:latest
    environment:
      MYSQL_ROOT_PASSWORD: '${MARIADB_MAIN_ROOT_PASSWORD}'
      PMA_HOST: mariadb-main
    ports:
      - '${PHPMYADMIN_EXPOSE_HOST}:${PHPMYADMIN_EXPOSE_PORT:-9001}:80'
    restart: always

  # Portainer
  portainer:
    container_name: portainer
    image: portainer/portainer-ce:alpine-sts
    ports:
      - '${PORTAINER_EXPOSE_HOST}:${PORTAINER_EXPOSE_PORT:-9000}:9000'
    restart: always
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data

  # Verdaccio
  verdaccio:
    container_name: verdaccio
    image: verdaccio/verdaccio
    ports:
      - '${VERDACCIO_EXPOSE_HOST}:${VERDACCIO_EXPOSE_PORT:-4873}:4873'
    restart: always
    volumes:
      - verdaccio-conf:/verdaccio/conf
      - verdaccio-plugins:/verdaccio/plugins
      - verdaccio-storage:/verdaccio/storage

volumes:
  dragonfly-main-data:
  mongodb-main-config:
  portainer-data:
  verdaccio-conf:
  verdaccio-plugins:
  verdaccio-storage:
